<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S3 Heater Control PWA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    .hidden { display: none; }
    #status { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; background: white; border-radius: 8px; }
    button { margin: 10px 0; padding: 12px 20px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; }
    button.start { background: #4CAF50; color: white; }
    button.stop { background: #f44336; color: white; }
    form { margin-top: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
    input, select { margin: 8px 0; padding: 8px; width: 100%; box-sizing: border-box; }
    label { display: block; margin-top: 12px; font-weight: bold; }
  </style>
  <link rel="manifest" href="/manifest.json">
</head>
<body>
  <div id="login" class="hidden">
    <h1>Login to Heater Control</h1>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p>Need an account? <button onclick="register()">Register</button></p>
  </div>

  <div id="main" class="hidden">
    <h1>S3 Heater Control</h1>
    <div id="status">
      <strong>Battery Temp:</strong> <span id="battery_temp">Loading...</span> °C<br>
      <strong>Fuel Tank:</strong> <span id="fuel_percent">Loading...</span> %<br>
      <strong>Heater:</strong> <span id="heater_status">Loading...</span><br>
      <strong>Charging:</strong> <span id="charging">Loading...</span>
    </div>

    <button class="start" onclick="startCycle()">Start Heating Cycle</button>
    <button class="stop" onclick="stopCycle()">Stop Heating Cycle</button>

    <h2>Scheduling & Settings</h2>
    <form id="configForm">
      <label>Low Battery Threshold (°C):</label>
      <input type="number" name="battery_low_threshold" value="15">

      <label>High Battery Threshold (°C):</label>
      <input type="number" name="battery_high_threshold" value="25">

      <label>Departure Time:</label>
      <input type="time" name="departure_time" value="07:30">

      <label>Maintain Battery Temp All Night:</label>
      <input type="checkbox" name="maintain_all_night" checked>

      <label>Tesla API Key (if needed):</label>
      <input type="text" name="api_key" placeholder="Enter your Tesla API key">

      <button type="button" onclick="saveConfig()">Save Settings</button>
    </form>
  </div>

  <script>
    const API_URL = 'http://192.168.1.100:5000';  // Replace with your Pi's IP (or domain later)

    // Show login or main screen
    function showLogin() { document.getElementById('login').style.display = 'block'; }
    function showMain() { document.getElementById('main').style.display = 'block'; loadConfig(); updateStatus(); setInterval(updateStatus, 30000); }

    // Basic auth helper
    function getAuthHeader() {
      const auth = localStorage.getItem('auth');
      return auth ? { 'Authorization': 'Basic ' + auth } : {};
    }

    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) return alert('Enter credentials');
      localStorage.setItem('auth', btoa(username + ':' + password));
      fetch(API_URL + '/status', { headers: getAuthHeader() })
        .then(res => { if (res.ok) showMain(); else alert('Login failed'); })
        .catch(() => alert('Connection error'));
    }

    function register() {
      const username = prompt('New Username:');
      const password = prompt('New Password:');
      if (!username || !password) return;
      fetch(API_URL + '/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
        .then(res => res.json())
        .then(data => alert(data.status))
        .catch(() => alert('Registration failed'));
    }

    function updateStatus() {
      fetch(API_URL + '/status', { headers: getAuthHeader() })
        .then(res => res.json())
        .then(data => {
          document.getElementById('battery_temp').innerText = data.battery_temp || 'N/A';
          document.getElementById('fuel_percent').innerText = data.fuel || 'N/A';
          document.getElementById('heater_status').innerText = data.heater || 'Off';
          document.getElementById('charging').innerText = data.charging || 'N/A';
        })
        .catch(err => console.error('Status update failed:', err));
    }

    function startCycle() {
      fetch(API_URL + '/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...getAuthHeader() },
        body: JSON.stringify({ cmd: 'start', level: 'medium' })
      })
        .then(() => alert('Heating cycle started: Coolant loop + S3'))
        .catch(() => alert('Failed to start'));
    }

    function stopCycle() {
      fetch(API_URL + '/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...getAuthHeader() },
        body: JSON.stringify({ cmd: 'stop' })
      })
        .then(() => alert('Heating cycle stopped: S3 off, loop running 15 min'))
        .catch(() => alert('Failed to stop'));
    }

    function loadConfig() {
      fetch(API_URL + '/config', { headers: getAuthHeader() })
        .then(res => res.json())
        .then(data => {
          document.querySelector('[name=battery_low_threshold]').value = data.battery_low_threshold || 15;
          document.querySelector('[name=battery_high_threshold]').value = data.battery_high_threshold || 25;
          document.querySelector('[name=departure_time]').value = data.departure_time || '07:30';
          document.querySelector('[name=maintain_all_night]').checked = data.maintain_all_night !== false;
        });
    }

    function saveConfig() {
      const form = document.getElementById('configForm');
      const data = {
        battery_low_threshold: parseInt(form.battery_low_threshold.value) || 15,
        battery_high_threshold: parseInt(form.battery_high_threshold.value) || 25,
        departure_time: form.departure_time.value || '07:30',
        maintain_all_night: form.maintain_all_night.checked,
        api_key: form.api_key.value.trim() || undefined
      };
      fetch(API_URL + '/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...getAuthHeader() },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(() => alert('Settings saved'))
        .catch(() => alert('Failed to save'));
    }

    // Initial load
    if (localStorage.getItem('auth')) {
      showMain();
    } else {
      showLogin();
    }
  </script>

  <!-- Manifest for PWA installability -->
  <script type="application/json" src="manifest.json">
    {
      "name": "S3 Heater Control",
      "short_name": "Heater Ctrl",
      "start_url": "/",
      "display": "standalone",
      "background_color": "#fff",
      "theme_color": "#4CAF50"
    }
  </script>
</body>
</html>